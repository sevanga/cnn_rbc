---
title: "R Notebook"
output:
  html_notebook: default
  pdf_document: default
---

Image recognition classification : 

```{r install, include=FALSE}

if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("EBImage", version = "3.8")
```

Voici les deux biblioth??ques nous utiliserons. EBImage permet de traiter et d'ouvrir les images ainsi que de traiter les donn??es li??es. Quand ?? Keras elle donne acc??s aux algorithmes de r??seaux de neuronnes profonds que nous utliserons pour ce mo??dele CNN. 
```{r}
library(EBImage)
library(keras)
```

```{r set1, include=FALSE}

set1 <- c('car_train_1.jpg',
'car_train_2.jpg',
'car_train_3.jpg',
'car_train_4.jpg',
'car_train_5.jpg',
'car_train_6.jpg',
'car_train_7.jpg',
'car_train_8.jpg',
'car_train_9.jpg',
'car_train_10.jpg',
'car_train_11.jpg',
'car_train_12.jpg',
'car_train_13.jpg',
'car_train_14.jpg',
'car_train_15.jpg',
'car_train_16.jpg',
'car_train_17.jpg',
'car_train_18.jpg',
'car_train_19.jpg',
'car_train_20.jpg',
'car_train_21.jpg',
'car_train_22.jpg',
'car_train_23.jpg',
'car_train_24.jpg',
'car_train_25.jpg',
'car_train_26.jpg',
'car_train_27.jpg',
'car_train_28.jpg',
'car_train_29.jpg',
'car_train_30.jpg',
'car_train_31.jpg',
'car_train_32.jpg',
'car_train_33.jpg',
'car_train_34.jpg',
'car_train_35.jpg',
'car_train_36.jpg',
'car_train_37.jpg',
'car_train_38.jpg',
'car_train_39.jpg',
'car_train_40.jpg',
'car_train_41.jpg',
'car_train_42.jpg',
'car_train_43.jpg',
'car_train_44.jpg',
'car_train_45.jpg',
'car_train_46.jpg',
'car_train_47.jpg',
'car_train_48.jpg',
'car_train_49.jpg',
'car_train_50.jpg',
'car_train_51.jpg',
'car_train_52.jpg',
'car_train_53.jpg',
'car_train_54.jpg',
'car_train_55.jpg',
'car_train_56.jpg',
'car_train_57.jpg',
'car_train_58.jpg',
'car_train_59.jpg',
'car_train_60.jpg',
'car_train_61.jpg',
'car_train_62.jpg',
'car_train_63.jpg',
'car_train_64.jpg',
'car_train_65.jpg',
'car_train_66.jpg',
'car_train_67.jpg',
'car_train_68.jpg',
'car_train_69.jpg',
'car_train_70.jpg',
'car_train_71.jpg',
'car_train_72.jpg',
'car_train_73.jpg',
'car_train_74.jpg',
'car_train_75.jpg',
'car_train_76.jpg',
'car_train_77.jpg',
'car_train_78.jpg',
'car_train_79.jpg',
'car_train_80.jpg',
'car_train_81.jpg',
'car_train_82.jpg',
'car_train_83.jpg',
'car_train_84.jpg',
'car_train_85.jpg',
'car_train_86.jpg',
'car_train_87.jpg',
'car_train_88.jpg',
'car_train_89.jpg',
'car_train_90.jpg',
'car_train_91.jpg',
'car_train_92.jpg',
'car_train_93.jpg',
'car_train_94.jpg',
'car_train_95.jpg',
'car_train_96.jpg',
'car_train_97.jpg',
'car_train_98.jpg',
'car_train_99.jpg',
'car_train_100.jpg',
'car_train_101.jpg',
'car_train_102.jpg',
'car_train_103.jpg',
'car_train_104.jpg',
'car_train_105.jpg',
'car_train_106.jpg',
'car_train_107.jpg',
'car_train_108.jpg',
'car_train_109.jpg',
'car_train_110.jpg',
'car_train_111.jpg',
'car_train_112.jpg',
'car_train_113.jpg',
'car_train_114.jpg',
'car_train_115.jpg',
'car_train_116.jpg',
'car_train_117.jpg',
'car_train_118.jpg',
'car_train_119.jpg',
'car_train_120.jpg',
'car_train_121.jpg',
'car_train_122.jpg',
'car_train_123.jpg',
'car_train_124.jpg',
'car_train_125.jpg',
'car_train_126.jpg',
'car_train_127.jpg',
'car_train_128.jpg',
'car_train_129.jpg',
'car_train_130.jpg',
'car_train_131.jpg',
'car_train_132.jpg',
'car_train_133.jpg',
'car_train_134.jpg',
'car_train_135.jpg',
'car_train_136.jpg',
'car_train_137.jpg',
'car_train_138.jpg',
'car_train_139.jpg',
'car_train_140.jpg',
'car_train_141.jpg',
'car_train_142.jpg',
'car_train_143.jpg',
'car_train_144.jpg',
'car_train_145.jpg',
'car_train_146.jpg',
'car_train_147.jpg',
'car_train_148.jpg',
'car_train_149.jpg',
'car_train_150.jpg',
'cat_train_1.jpg',
'cat_train_2.jpg',
'cat_train_3.jpg',
'cat_train_4.jpg',
'cat_train_5.jpg',
'cat_train_6.jpg',
'cat_train_7.jpg',
'cat_train_8.jpg',
'cat_train_9.jpg',
'cat_train_10.jpg',
'cat_train_11.jpg',
'cat_train_12.jpg',
'cat_train_13.jpg',
'cat_train_14.jpg',
'cat_train_15.jpg',
'cat_train_16.jpg',
'cat_train_17.jpg',
'cat_train_18.jpg',
'cat_train_19.jpg',
'cat_train_20.jpg',
'cat_train_21.jpg',
'cat_train_22.jpg',
'cat_train_23.jpg',
'cat_train_24.jpg',
'cat_train_25.jpg',
'cat_train_26.jpg',
'cat_train_27.jpg',
'cat_train_28.jpg',
'cat_train_29.jpg',
'cat_train_30.jpg',
'cat_train_31.jpg',
'cat_train_32.jpg',
'cat_train_33.jpg',
'cat_train_34.jpg',
'cat_train_35.jpg',
'cat_train_36.jpg',
'cat_train_37.jpg',
'cat_train_38.jpg',
'cat_train_39.jpg',
'cat_train_40.jpg',
'cat_train_41.jpg',
'cat_train_42.jpg',
'cat_train_43.jpg',
'cat_train_44.jpg',
'cat_train_45.jpg',
'cat_train_46.jpg',
'cat_train_47.jpg',
'cat_train_48.jpg',
'cat_train_49.jpg',
'cat_train_50.jpg',
'cat_train_51.jpg',
'cat_train_52.jpg',
'cat_train_53.jpg',
'cat_train_54.jpg',
'cat_train_55.jpg',
'cat_train_56.jpg',
'cat_train_57.jpg',
'cat_train_58.jpg',
'cat_train_59.jpg',
'cat_train_60.jpg',
'cat_train_61.jpg',
'cat_train_62.jpg',
'cat_train_63.jpg',
'cat_train_64.jpg',
'cat_train_65.jpg',
'cat_train_66.jpg',
'cat_train_67.jpg',
'cat_train_68.jpg',
'cat_train_69.jpg',
'cat_train_70.jpg',
'cat_train_71.jpg',
'cat_train_72.jpg',
'cat_train_73.jpg',
'cat_train_74.jpg',
'cat_train_75.jpg',
'cat_train_76.jpg',
'cat_train_77.jpg',
'cat_train_78.jpg',
'cat_train_79.jpg',
'cat_train_80.jpg',
'cat_train_81.jpg',
'cat_train_82.jpg',
'cat_train_83.jpg',
'cat_train_84.jpg',
'cat_train_85.jpg',
'cat_train_86.jpg',
'cat_train_87.jpg',
'cat_train_88.jpg',
'cat_train_89.jpg',
'cat_train_90.jpg',
'cat_train_91.jpg',
'cat_train_92.jpg',
'cat_train_93.jpg',
'cat_train_94.jpg',
'cat_train_95.jpg',
'cat_train_96.jpg',
'cat_train_97.jpg',
'cat_train_98.jpg',
'cat_train_99.jpg',
'cat_train_100.jpg',
'cat_train_101.jpg',
'cat_train_102.jpg',
'cat_train_103.jpg',
'cat_train_104.jpg',
'cat_train_105.jpg',
'cat_train_106.jpg',
'cat_train_107.jpg',
'cat_train_108.jpg',
'cat_train_109.jpg',
'cat_train_110.jpg',
'cat_train_111.jpg',
'cat_train_112.jpg',
'cat_train_113.jpg',
'cat_train_114.jpg',
'cat_train_115.jpg',
'cat_train_116.jpg',
'cat_train_117.jpg',
'cat_train_118.jpg',
'cat_train_119.jpg',
'cat_train_120.jpg',
'cat_train_121.jpg',
'cat_train_122.jpg',
'cat_train_123.jpg',
'cat_train_124.jpg',
'cat_train_125.jpg',
'cat_train_126.jpg',
'cat_train_127.jpg',
'cat_train_128.jpg',
'cat_train_129.jpg',
'cat_train_130.jpg',
'cat_train_131.jpg',
'cat_train_132.jpg',
'cat_train_133.jpg',
'cat_train_134.jpg',
'cat_train_135.jpg',
'cat_train_136.jpg',
'cat_train_137.jpg',
'cat_train_138.jpg',
'cat_train_139.jpg',
'cat_train_140.jpg',
'cat_train_141.jpg',
'cat_train_142.jpg',
'cat_train_143.jpg',
'cat_train_144.jpg',
'cat_train_145.jpg',
'cat_train_146.jpg',
'cat_train_147.jpg',
'cat_train_148.jpg',
'cat_train_149.jpg',
'cat_train_150.jpg',
'flower_train_1.jpg',
'flower_train_2.jpg',
'flower_train_3.jpg',
'flower_train_4.jpg',
'flower_train_5.jpg',
'flower_train_6.jpg',
'flower_train_7.jpg',
'flower_train_8.jpg',
'flower_train_9.jpg',
'flower_train_10.jpg',
'flower_train_11.jpg',
'flower_train_12.jpg',
'flower_train_13.jpg',
'flower_train_14.jpg',
'flower_train_15.jpg',
'flower_train_16.jpg',
'flower_train_17.jpg',
'flower_train_18.jpg',
'flower_train_19.jpg',
'flower_train_20.jpg',
'flower_train_21.jpg',
'flower_train_22.jpg',
'flower_train_23.jpg',
'flower_train_24.jpg',
'flower_train_25.jpg',
'flower_train_26.jpg',
'flower_train_27.jpg',
'flower_train_28.jpg',
'flower_train_29.jpg',
'flower_train_30.jpg',
'flower_train_31.jpg',
'flower_train_32.jpg',
'flower_train_33.jpg',
'flower_train_34.jpg',
'flower_train_35.jpg',
'flower_train_36.jpg',
'flower_train_37.jpg',
'flower_train_38.jpg',
'flower_train_39.jpg',
'flower_train_40.jpg',
'flower_train_41.jpg',
'flower_train_42.jpg',
'flower_train_43.jpg',
'flower_train_44.jpg',
'flower_train_45.jpg',
'flower_train_46.jpg',
'flower_train_47.jpg',
'flower_train_48.jpg',
'flower_train_49.jpg',
'flower_train_50.jpg',
'flower_train_51.jpg',
'flower_train_52.jpg',
'flower_train_53.jpg',
'flower_train_54.jpg',
'flower_train_55.jpg',
'flower_train_56.jpg',
'flower_train_57.jpg',
'flower_train_58.jpg',
'flower_train_59.jpg',
'flower_train_60.jpg',
'flower_train_61.jpg',
'flower_train_62.jpg',
'flower_train_63.jpg',
'flower_train_64.jpg',
'flower_train_65.jpg',
'flower_train_66.jpg',
'flower_train_67.jpg',
'flower_train_68.jpg',
'flower_train_69.jpg',
'flower_train_70.jpg',
'flower_train_71.jpg',
'flower_train_72.jpg',
'flower_train_73.jpg',
'flower_train_74.jpg',
'flower_train_75.jpg',
'flower_train_76.jpg',
'flower_train_77.jpg',
'flower_train_78.jpg',
'flower_train_79.jpg',
'flower_train_80.jpg',
'flower_train_81.jpg',
'flower_train_82.jpg',
'flower_train_83.jpg',
'flower_train_84.jpg',
'flower_train_85.jpg',
'flower_train_86.jpg',
'flower_train_87.jpg',
'flower_train_88.jpg',
'flower_train_89.jpg',
'flower_train_90.jpg',
'flower_train_91.jpg',
'flower_train_92.jpg',
'flower_train_93.jpg',
'flower_train_94.jpg',
'flower_train_95.jpg',
'flower_train_96.jpg',
'flower_train_97.jpg',
'flower_train_98.jpg',
'flower_train_99.jpg',
'flower_train_100.jpg',
'flower_train_101.jpg',
'flower_train_102.jpg',
'flower_train_103.jpg',
'flower_train_104.jpg',
'flower_train_105.jpg',
'flower_train_106.jpg',
'flower_train_107.jpg',
'flower_train_108.jpg',
'flower_train_109.jpg',
'flower_train_110.jpg',
'flower_train_111.jpg',
'flower_train_112.jpg',
'flower_train_113.jpg',
'flower_train_114.jpg',
'flower_train_115.jpg',
'flower_train_116.jpg',
'flower_train_117.jpg',
'flower_train_118.jpg',
'flower_train_119.jpg',
'flower_train_120.jpg',
'flower_train_121.jpg',
'flower_train_122.jpg',
'flower_train_123.jpg',
'flower_train_124.jpg',
'flower_train_125.jpg',
'flower_train_126.jpg',
'flower_train_127.jpg',
'flower_train_128.jpg',
'flower_train_129.jpg',
'flower_train_130.jpg',
'flower_train_131.jpg',
'flower_train_132.jpg',
'flower_train_133.jpg',
'flower_train_134.jpg',
'flower_train_135.jpg',
'flower_train_136.jpg',
'flower_train_137.jpg',
'flower_train_138.jpg',
'flower_train_139.jpg',
'flower_train_140.jpg',
'flower_train_141.jpg',
'flower_train_142.jpg',
'flower_train_143.jpg',
'flower_train_144.jpg',
'flower_train_145.jpg',
'flower_train_146.jpg',
'flower_train_147.jpg',
'flower_train_148.jpg',
'flower_train_149.jpg',
'flower_train_150.jpg')

train <- list()
for (i in 1:450){train[[i]] <- readImage(set1[i])}
```

```{r set2, include=FALSE}
set2 <- c('car_train_476.jpg',
'car_train_477.jpg',
'car_train_478.jpg',
'car_train_479.jpg',
'car_train_480.jpg',
'car_train_481.jpg',
'car_train_482.jpg',
'car_train_483.jpg',
'car_train_484.jpg',
'car_train_485.jpg',
'cat_train_581.jpg',
'cat_train_582.jpg',
'cat_train_583.jpg',
'cat_train_584.jpg',
'cat_train_585.jpg',
'cat_train_586.jpg',
'cat_train_587.jpg',
'cat_train_588.jpg',
'cat_train_589.jpg',
'cat_train_590.jpg',
'flower_train_512.jpg',
'flower_train_513.jpg',
'flower_train_514.jpg',
'flower_train_515.jpg',
'flower_train_516.jpg',
'flower_train_517.jpg',
'flower_train_518.jpg',
'flower_train_519.jpg',
'flower_train_520.jpg',
'flower_train_521.jpg')
setwd("~/Documents/COURS/UTC/GI05/SY19/TP7/sy19-tp7/images")

test <- list()
for (i in 1:30){test[[i]] <- readImage(set2[i])}
```

D'abord il faut homog??n??iser toutes les photos dans la m??me dimension pour pouvoir les traiter ult??rieurement. On a donc choisie une taille de 100x100 pour avoir assez de donn??es images pour avoir une bonne pr??diction sans faire crasher l'ordinateur.
De plus, nous allons combiner les matrices de train en une seule, de m??me pour test
```{r}
### Resize
for (i in 1:450){train[[i]] <-resize(train[[i]], 100, 100)}
for (i in 1:30){test[[i]] <-resize(test[[i]], 100, 100)}
train <- combine(train)
test <- combine(test)
```

Il faut r??organiser les dimensions, la 4 colonnes n'??tant pas ?? la bonne place pour le traitement que nous allons r??aliser i.e. un CNN, il faut que le nombre d'images soient en premi??re position
```{r}
### Reorder dimensions 
train <- aperm(train, c(4, 1, 2, 3))
test <- aperm(test, c(4, 1, 2, 3))
```

Nous g??n??rons les vecteurs y de r??ponses, puis nous en faisons des vecteurs de classes binaires, ce qui nous permettra d'utiliser la categorical crossentropy pour le mod??le suivant.
```{r}
### Response
### 0 : car 1 : cat 2 : flower 
trainy <- c(rep(0,150), rep(1,150), rep(2,150))
testy <- c(rep(0,10), rep(1,10), rep(2,10))

trainLabels <- to_categorical(trainy)
testLabels <- to_categorical(testy)

```

Pour ce mod??le, nous utilisons une succession de couche de convolution ?? 32 filtres, des couches de pooling ?? filtres de dimensions 2x2, qui servent de sous ??chantillonage des images ainsi que le dropout avec un taux de probabilit?? de fermeture de neurone de 0.25 pour simuler un bagging. On augmente le nombre de filtre ?? 64 lorsqu'on est proche de la sortie pour pr??server l'information ?? travers les couches.
La fonction ReLu (Rectified Linear Unit) est une fonction de correction qui est certainement la plus rapide sans en affecter grandement la pr??cision (d'o?? ce choix)
```{r}
### Model 
model <- keras_model_sequential()
model %>%
  layer_conv_2d(filter = 32, 
                kernel_size = c(3,3),
                activation = 'relu') %>%
  layer_conv_2d(filter = 32, 
                kernel_size = c(3,3),
                activation = 'relu') %>%
  layer_max_pooling_2d(pool_size = c(2,2)) %>%
  layer_dropout(rate = 0.25) %>%
  layer_conv_2d(filter = 64, 
                kernel_size = c(3,3),
                activation = 'relu') %>%
  layer_max_pooling_2d(pool_size = c(2,2)) %>%
  layer_dropout(rate = 0.25) %>%
  layer_flatten() %>%
  layer_dense(units = 256, activation = 'relu') %>%
  layer_dropout(rate = 0.25) %>%
  layer_dense(units = 3, activation = 'softmax') %>%
  compile(loss = 'categorical_crossentropy',
          optimizer = optimizer_sgd(lr = 0.01,
                                    decay = 1e-6,
                                    momentum = 0.9,
                                    nesterov = T),
          metrics = c('accuracy'))
  
```

On fit le mod??le avec un batch size de 30, i.e. le dataset qui rentrera dans le r??seau en entr??e sera de 30. epochs est le nombre de fois o?? ce dataset va traverser le r??seau en entier. On divise ce dataset en batch car trop gros pour passer une fois. Le taux de validation est fix?? ?? 20%.
On peut voir les r??sultats qui s'am??liorent avec le temps gr??ce aux courbes comme escompt??.
```{r}
### FitModel 
history <- model %>% 
  fit(train,
      trainLabels, 
      epochs=30, 
      batch_size=100,
      validation_split=0.2)

plot(history)
```

On r??alise les tests. Il semble que le mod??le soit efficace, lorsque l'on voit les pr??dictions sur les donn??es de test et qu'on les compare avec leur v??ritables valeurs, on a une accuracy d'environ 85%, ce chiffre pourrait ??tre am??liorer je pense avec un mod??le plus complexe ou peut ??tre plus de donn??es.
Avec une machine plus puissante, on pourrait surement le r??aliser. 
```{r}
#### Evaluation 
model %>% evaluate(train, trainLabels)
pred <- model %>% predict_classes(train)
table(Predicted=pred, Actual = trainy)
prob <- model %>% predict_proba(train)
cbind(prob, Predicted_class = pred, actual = trainy)

#### Test
model %>% evaluate(test, testLabels)
pred <- model %>% predict_classes(test)
table(Predicted=pred, Actual = testy)
prob <- model %>% predict_proba(train)
cbind(prob, Predicted_class = pred, actual = testy)
```

```{r}
model %>% save_model_weights_hdf5("CNNModelv3.h5")
```